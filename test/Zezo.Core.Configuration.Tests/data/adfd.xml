<Project Id="adfd">
    <Project.Name>Digitalisation of ADFD</Project.Name>
    <Project.Pipeline>
        <Sequence Id="normal_flow">
            <Sequence.Children>
                <Xor Id="transcribe">
                    <Xor.Children>
                        <If Id="transcribe_all_wrapper">
                            <If.Child>
                                <Interactive 
                                    Id="transcribe_all"
                                    Queue="all"
                                    TimeLimit="5min" >
                                    <Interactive.BeforePublish>
                                        <ScriptProcessor Source="PrepareData.csscript"/>
                                    </Interactive.BeforePublish>
                                    <Interactive.BeforeSubmit>
                                        <ScriptProcessor Class="CleanWhiteSpaces" />
                                        <ScriptGuard Source="CheckAllFields.csscript" />
                                    </Interactive.BeforeSubmit>
                                    <Interactive.AfterSubmit>
                                        <SaveRevisionProcessor />
                                    </Interactive.AfterSubmit>
                                </Interactive>
                            </If.Child>
                            <If.Condition>
                                <ScriptCondition Language="csharp">
                                    <![CDATA[
                                        not (all fields are valid)
                                    ]]>
                                </ScriptCondition>
                            </If.Condition>
                        </If>
                        <Parallel Id="transcribe_separate">
                            <Parallel.Children>
                                <If Id="buc_wrapper">
                                    <If.Child>
                                        <Interactive Id="transcribe_buc" Queue="buc" TimeLimit="5min">
                                            <Interactive.BeforePublish>
                                                <ScriptProcessor Source="PrepareDataBUC.csscript" />
                                            </Interactive.BeforePublish>
                                            <Interactive.BeforeSubmit>
                                                <ScriptProcessor Class="CleanWhiteSpaces" />
                                                <ScriptGuard Source="CheckBUC.csscript" />
                                            </Interactive.BeforeSubmit>
                                            <Interactive.AfterSubmit>
                                                <SaveRevisionProcessor />
                                            </Interactive.AfterSubmit>
                                        </Interactive>
                                    </If.Child>
                                    <If.Condition>
                                        <ScriptCondition Language="csharp">
                                            <![CDATA[
                                                not (buc field already filled)
                                            ]]>
                                        </ScriptCondition>
                                    </If.Condition>
                                </If>

                                <If Id="chi_wrapper">
                                    <If.Child>
                                        <Interactive Id="transcribe_chi" Queue="chi" TimeLimit="5min">
                                            <Interactive.BeforePublish>
                                                <ScriptProcessor Source="PrepareDataCHI.csscript" />
                                            </Interactive.BeforePublish>
                                            <Interactive.BeforeSubmit>
                                                <ScriptProcessor Class="CleanWhiteSpaces" />
                                                <ScriptGuard Source="CheckCHI.csscript" />
                                            </Interactive.BeforeSubmit>
                                            <Interactive.AfterSubmit>
                                                <SaveRevisionProcessor />
                                            </Interactive.AfterSubmit>
                                        </Interactive>
                                    </If.Child>
                                    <If.Condition>
                                        <ScriptCondition Language="csharp">
                                            <![CDATA[
                                                not (chi field already filled)
                                            ]]>
                                        </ScriptCondition>
                                    </If.Condition>
                                </If>

                                <If Id="eng_wrapper">
                                    <If.Child>
                                        <Interactive Id="transcribe_eng" Queue="eng" TimeLimit="5min">
                                            <Interactive.BeforePublish>
                                                <ScriptProcessor Source="PrepareDataENG.csscript" />
                                            </Interactive.BeforePublish>
                                            <Interactive.BeforeSubmit>
                                                <ScriptProcessor Class="CleanWhiteSpaces" />
                                                <ScriptGuard Source="CheckENG.csscript" />
                                            </Interactive.BeforeSubmit>
                                            <Interactive.AfterSubmit>
                                                <SaveRevisionProcessor />
                                            </Interactive.AfterSubmit>
                                        </Interactive>
                                    </If.Child>
                                    <If.Condition>
                                        <ScriptCondition Language="csharp">
                                            <![CDATA[
                                                not (eng field already checked by human)
                                            ]]>
                                        </ScriptCondition>
                                    </If.Condition>
                                </If>
                            </Parallel.Children>
                        </Parallel>
                    </Xor.Children>
                </Xor>
                <DoWhile Id="review">
                    <DoWhile.ChildTemplate>
                        <Interactive Id="review_all" Queue="review">
                            <Interactive.Inputs>
                                <FieldDef Id="AllFields" Type="Json" Nullable="True" Description="所有字段" />
                            </Interactive.Inputs>
                            <Interactive.Outputs>
                                <FieldDef Id="Action" Type="String" Nullable="False" />
                                <!-- One of: ApprovedNoChanges, ApprovedWithChanges -->
                                <FieldDef Id="Changes" Type="Json" Nullable="True" />
                            </Interactive.Outputs>
                            <Interactive.BeforePublish>
                                <ScriptProcessor Class="SummarizeFields" />
                                <ScriptProcessor Class="ConcatRevisions" />
                            </Interactive.BeforePublish>
                            <Interactive.AfterSubmit>
                                <!--<ScriptProcessor Class="AssignCredit" />-->
                                <ScriptProcessor Class="Save" />
                                <!-- Should probably assign credit after review -->
                            </Interactive.AfterSubmit>
                        </Interactive>
                    </DoWhile.ChildTemplate>
                    <DoWhile.Condition>
                        <ScriptCondition Language="csharp">
                            <![CDATA[
                                // repeat until there are two consecative approvals.
                                var = this.PreviousOutput;
                                if (this.PreviousOutput == "ApprovedNoChanges") {
                                    this.DataStore["approvals"].Flags["Approvals"].Up();
                                    if (this.DataStore["approvals"].Flags["Approvals"].GetCount() >=2) {
                                        return true;
                                    }
                                } else {
                                    this.DataStore["approvals"].Flags["Approvals"].Cleared();
                                }
                                return false;
                            ]]>
                        </ScriptCondition>
                    </DoWhile.Condition>
                </DoWhile>
            </Sequence.Children>
        </Sequence>
    </Project.Pipeline>
    <Project.Datastores>
        <SimpleStore Id="default">
            <SimpleStore.Fields>
                <FieldDef Id="ImageFile" Type="String" Nullable="False" />
            </SimpleStore.Fields>
        </SimpleStore>
        <JournalStore Id="fields">
            <JournalStore.Fields>
                <FieldDef Id="TextBUC" Type="String" Nullable="True"/>
                <FieldDef Id="TextEng" Type="String" Nullable="True"/>
                <FieldDef Id="TextChi" Type="String" Nullable="True"/>
                <FieldDef Id="IsOral" Type="Boolean" Nullable="False"/>
            </JournalStore.Fields>
        </JournalStore>
        <FlagsStore Id="flags">
            <FlagsStore.Types>
                <Flag Name="SegmentationError">
                    <!--圖片切割錯誤-->
                </Flag>
                <Flag Name="Question">
                    <!--問題-->
                </Flag>
            </FlagsStore.Types>
        </FlagsStore>
    </Project.Datastores>
    <Project.LifeCycle>
        <ScriptLifeCycleHandler On="DataStoreUpdated">
            <![CDATA[
                var segmentErrorCount = DataStore["flags"].Flags["SegmentationError"].GetCount();
                if (segmentErrorCount >= 1) {
                    this.normal_flow.Pause();
                } else if (this.normal_flow.GetState()=="Paused") {
                    this.normal_flow.Resume();
                }
            ]]>
        </ScriptLifeCycleHandler>
    </Project.LifeCycle>
    <Project.Queues>
        <Queue Id="all" Name="Transcribe All Queue" />
        <Queue Id="buc" Name="Transcribe BUC Queue" />
        <Queue Id="chi" Name="Transcribe Chinese Queue" />
        <Queue Id="eng" Name="Transcribe English Queue" />
        <Queue Id="review" Name="Reviewing queue">
            <Queue.Permissions>
                <HasRole Role="Administrator" />
            </Queue.Permissions>
        </Queue>
    </Project.Queues>
</Project>
